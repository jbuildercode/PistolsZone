<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receipt - PistolsZone</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #e5e5e5;
        margin: 0;
        padding: 0;
    }
    .receipt-container {
        max-width: 800px;
        margin: 40px auto;
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .company-info { text-align: center; margin-bottom: 30px; white-space: pre-wrap; }
    .info-table, .items-table, .totals-table {
        width: 100%;
        border-collapse: collapse;
    }
    .info-table td, .items-table th, .items-table td {
        padding: 8px;
        border: 1px solid #ddd;
    }
    .items-table th {
        background: #1b263b;
        color: white;
    }
    .totals-table { width: 50%; float: right; }
    .totals-table td { border: none; padding: 5px 10px; }
    .totals-table tr td:first-child { text-align: right; font-weight: bold; }
    .clear { clear: both; }
    .btn {
        display:block;
        width:200px;
        padding:12px;
        margin:20px auto 0 auto;
        background:#1b263b;
        color:white;
        border-radius:8px;
        font-weight:bold;
        border:none;
        cursor:pointer;
    }
</style>
</head>
<body>

<div class="receipt-container">

    <div class="company-info" id="companyInfo"></div>

    <table class="info-table" id="infoTable"></table>

    <table class="items-table">
        <thead>
            <tr>
                <th>QTY</th>
                <th>DESCRIPTION</th>
                <th>UNIT PRICE</th>
                <th>AMOUNT</th>
            </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
    </table>

    <table class="totals-table" id="totalsTable"></table>
    <div class="clear"></div>

    <button class="btn" onclick="newOrder()">Start New Order</button>
    <button class="btn" onclick="window.print()">Print Receipt</button>

</div>

<script>
/* =======================
   LOGIN CHECK
======================= */
const user = localStorage.getItem("loggedInUser");
if (!user) {
    alert("You must be logged in.");
    window.location.href = "login.html";
}

/* =======================
   ✅ CORRECT USER STORAGE
======================= */
const userKey = `userInfo_${user}`;
const userInfo = JSON.parse(localStorage.getItem(userKey));

if (!userInfo || !userInfo.address) {
    alert("Please complete your profile first.");
    window.location.href = "user.html";
}

/* =======================
   USER CART
======================= */
const cartKey = `cart_${user}`;
const cart = JSON.parse(localStorage.getItem(cartKey)) || [];

/* =======================
   RECEIPT META
======================= */
const today = new Date();
const invoice = parseInt(localStorage.getItem("lastInvoice") || "0") + 1;
localStorage.setItem("lastInvoice", invoice);
const invoiceNumber = invoice.toString().padStart(8, "0");

/* =======================
   TOTALS
======================= */
let subtotal = 0;
cart.forEach(i => subtotal += i.qty * i.price);
const tax = subtotal * 0.0025;
const total = subtotal + tax;

/* =======================
   TYPE EFFECT
======================= */
async function typeText(el, text, delay=20){
    el.textContent="";
    for(let c of text){
        el.textContent+=c;
        await new Promise(r=>setTimeout(r,delay));
    }
}

/* =======================
   BUILD RECEIPT
======================= */
async function buildReceipt(){

    await typeText(
        document.getElementById("companyInfo"),
        `PistolsZone\nPrecision. Reliability. Performance.\nRECEIPT\n\n`, 25
    );

    document.getElementById("infoTable").innerHTML = `
        <tr>
            <td><b>Bill To:</b><br>${userInfo.fullname}<br>${userInfo.address}</td>
            <td><b>Ship To:</b><br>${userInfo.fullname}<br>${userInfo.address}</td>
        </tr>
        <tr>
            <td><b>Receipt Date:</b> ${today.toLocaleDateString()}</td>
            <td><b>Invoice #:</b> ${invoiceNumber}</td>
        </tr>
    `;

    const body = document.getElementById("itemsBody");
    body.innerHTML = "";

    for (let item of cart) {
        const amount = item.qty * item.price;
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${item.qty}</td>
            <td>${item.name}</td>
            <td>₱${item.price.toFixed(2)}</td>
            <td>₱${amount.toFixed(2)}</td>
        `;
        body.appendChild(tr);
    }

    document.getElementById("totalsTable").innerHTML = `
        <tr><td>Subtotal:</td><td>₱${subtotal.toFixed(2)}</td></tr>
        <tr><td>Sales Tax 0.25%:</td><td>₱${tax.toFixed(2)}</td></tr>
        <tr><td>Total:</td><td>₱${total.toFixed(2)}</td></tr>
    `;
}

/* =======================
   NEW ORDER
======================= */
function newOrder(){
    localStorage.removeItem(cartKey);
    window.location.href = "pistols.html";
}

buildReceipt();
</script>

</body>
</html>
